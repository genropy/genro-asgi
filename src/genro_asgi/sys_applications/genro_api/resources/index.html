<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Genro API Explorer</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.18/cdn/themes/light.css">
  <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.18/cdn/shoelace-autoloader.js"></script>
  <script type="module" src="static?file=tree.js"></script>
  <script type="module" src="static?file=doc.js"></script>
  <script type="module" src="static?file=tester.js"></script>
  <script type="module" src="static?file=response.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    #toolbar {
      padding: 10px 20px;
      background: #1b1b1b;
      display: flex;
      align-items: center;
      gap: 15px;
      color: white;
      font-size: 14px;
    }
    #toolbar .title {
      font-weight: 600;
      font-size: 1.1rem;
      white-space: nowrap;
    }
    #toolbar input[type="text"] {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #444;
      border-radius: 4px;
      background: #2d2d2d;
      color: white;
      font-size: 14px;
      min-width: 200px;
    }
    #toolbar select {
      padding: 8px;
      border-radius: 4px;
      background: #2d2d2d;
      color: white;
      border: 1px solid #444;
    }
    #toolbar button {
      padding: 8px 20px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }
    #toolbar button:hover { background: #45a049; }
    #toolbar .separator {
      width: 1px;
      height: 24px;
      background: #444;
    }
    main {
      flex: 1;
      min-height: 0;
    }
    sl-split-panel {
      --divider-width: 4px;
      height: 100%;
    }
    .panel {
      height: 100%;
      overflow: auto;
    }
    .panel-placeholder {
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      font-weight: bold;
      color: #64748b;
      background: #f8fafc;
      border: 1px dashed #cbd5e1;
    }
    .panel-tree { background: #f0fdf4; }
    .panel-doc { background: #eff6ff; border-color: #93c5fd; color: #1e40af; }
    .panel-tester { background: #fef3c7; border-color: #fcd34d; color: #92400e; }
    .panel-response { background: #fce7f3; border-color: #f9a8d4; color: #9d174d; }
  </style>
</head>
<body>
  <div id="toolbar">
    <span class="title">Genro API Explorer</span>
    <div class="separator"></div>
    <select id="url-presets">
      <option value="">-- Select API --</option>
      <option value="local">This server</option>
      <option value="https://petstore.swagger.io/v2/swagger.json">Petstore v2</option>
      <option value="https://petstore3.swagger.io/api/v3/openapi.json">Petstore v3</option>
      <option value="https://api.apis.guru/v2/openapi.yaml">APIs.guru</option>
    </select>
    <input id="url-input" type="text" placeholder="Enter OpenAPI URL or select from menu">
    <button id="load-btn">Load</button>
    <div class="separator"></div>
    <select id="app-select" style="display: none;">
      <option value="">-- Server Router --</option>
    </select>
  </div>
  <main>
    <sl-split-panel position="25">
      <div slot="start" class="panel panel-tree">
        <api-tree id="api-tree"></api-tree>
      </div>
      <div slot="end">
        <sl-split-panel vertical position="40">
          <div slot="start" class="panel panel-doc">
            <api-doc id="api-doc"></api-doc>
          </div>
          <div slot="end">
            <sl-split-panel position="50">
              <div slot="start" class="panel panel-tester">
                <api-tester id="api-tester"></api-tester>
              </div>
              <div slot="end" class="panel panel-response">
                <api-response id="api-response"></api-response>
              </div>
            </sl-split-panel>
          </div>
        </sl-split-panel>
      </div>
    </sl-split-panel>
  </main>

  <script type="module">
    const tree = document.getElementById("api-tree");
    const doc = document.getElementById("api-doc");
    const tester = document.getElementById("api-tester");
    const response = document.getElementById("api-response");
    const appSelect = document.getElementById("app-select");
    const urlPresets = document.getElementById("url-presets");
    const urlInput = document.getElementById("url-input");
    const loadBtn = document.getElementById("load-btn");

    // Check if app/basepath are fixed via URL
    const fixedApp = window.GENRO_API_INITIAL_APP || "";
    const fixedBasepath = window.GENRO_API_INITIAL_BASEPATH || "";

    // Current mode: "local" or "remote"
    let currentMode = "local";
    let currentRemoteUrl = "";

    async function init() {
      if (fixedApp) {
        // Fixed app mode: hide toolbar controls, use fixed app and basepath
        urlPresets.style.display = "none";
        urlInput.style.display = "none";
        loadBtn.style.display = "none";
        tree.loadNodes(fixedApp, fixedBasepath);
        doc.setApp(fixedApp);
        tester.setApp(fixedApp);
      }
      // Don't auto-load anything, wait for user selection
    }

    // Preset dropdown changes
    urlPresets.addEventListener("change", () => {
      const val = urlPresets.value;
      if (val === "local") {
        urlInput.value = "";
        urlInput.placeholder = "Select app from dropdown after loading";
      } else if (val) {
        urlInput.value = val;
      }
    });

    // Load button click
    loadBtn.addEventListener("click", loadApi);

    async function loadApi() {
      const url = urlInput.value.trim();
      const preset = urlPresets.value;

      if (preset === "local" || !url) {
        // Local mode: load this server's apps
        currentMode = "local";
        appSelect.style.display = "inline-block";
        await loadLocalApps();
      } else {
        // Remote mode: fetch OpenAPI from URL
        currentMode = "remote";
        currentRemoteUrl = url;
        appSelect.style.display = "none";
        await loadRemoteOpenApi(url);
      }
    }

    async function loadLocalApps() {
      // Clear and repopulate app dropdown
      appSelect.innerHTML = '<option value="">-- Server Router --</option>';
      try {
        const res = await fetch("apps");
        const data = await res.json();
        for (const app of data.apps || []) {
          const option = document.createElement("option");
          option.value = app.name;
          option.textContent = app.name;
          appSelect.appendChild(option);
        }
        // Load server router by default
        tree.loadNodes();
        doc.setApp("");
        tester.setApp("");
        doc.showPlaceholder();
        tester.showPlaceholder();
        response.showPlaceholder();
      } catch (err) {
        console.error("Failed to load apps:", err);
      }
    }

    async function loadRemoteOpenApi(url) {
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const contentType = res.headers.get("content-type") || "";
        let data;
        if (contentType.includes("yaml") || url.endsWith(".yaml") || url.endsWith(".yml")) {
          // Would need a YAML parser for YAML files
          const text = await res.text();
          // For now, try JSON parse (most APIs return JSON)
          try {
            data = JSON.parse(text);
          } catch {
            alert("YAML parsing not yet supported. Please use JSON OpenAPI URLs.");
            return;
          }
        } else {
          data = await res.json();
        }
        // Load the OpenAPI schema into the tree
        tree.loadOpenApi(data, url);
        doc.setRemoteMode(url);
        tester.setRemoteMode(url);
        doc.showPlaceholder();
        tester.showPlaceholder();
        response.showPlaceholder();
      } catch (err) {
        console.error("Failed to load OpenAPI:", err);
        alert(`Failed to load OpenAPI: ${err.message}`);
      }
    }

    // Reload tree when app selection changes (local mode only)
    appSelect.addEventListener("change", () => {
      if (currentMode !== "local") return;
      const app = appSelect.value;
      tree.loadNodes(app);
      doc.setApp(app);
      doc.showPlaceholder();
      tester.setApp(app);
      tester.showPlaceholder();
      response.showPlaceholder();
    });

    // Handle node selection (endpoints and routers)
    tree.addEventListener("node-selected", async (e) => {
      console.log("Selected node:", e.detail);

      if (currentMode === "remote") {
        // Remote mode: data is already in the event
        const nodeData = e.detail.data;
        doc.render(nodeData);
        tester.setEndpoint(nodeData, e.detail.path);
        response.showPlaceholder();
        return;
      }

      // Local mode: fetch doc from server
      const currentApp = fixedApp || appSelect.value;
      const selectedPath = e.detail.path;
      doc.setApp(currentApp);
      tester.setApp(currentApp);

      const params = new URLSearchParams({ path: selectedPath });
      if (currentApp) params.set("app", currentApp);
      const url = `getdoc?${params}`;

      try {
        const res = await fetch(url);
        const data = await res.json();
        doc.render(data);
        tester.setEndpoint(data, selectedPath);
        response.showPlaceholder();
      } catch (err) {
        console.error("Failed to load doc:", err);
      }
    });

    // Handle API response from tester
    tester.addEventListener("api-response", (e) => {
      console.log("API response:", e.detail);
      response.setResponse(e.detail);
    });

    init();
  </script>
</body>
</html>
