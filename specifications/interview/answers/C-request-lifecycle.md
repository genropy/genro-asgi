# C. Request Lifecycle (Request/Response)

**Date**: 2025-12-13
**Status**: Verified

---

## Logical vs Concrete Request

There is a **logical request** (`BaseRequest`) that materializes into:

- `HttpRequest` - native HTTP request (ASGI scope)
- `WsxRequest` - pseudo-request from WSX message (WebSocket/NATS)

The handler always sees `BaseRequest` with a uniform interface.

## Flow

```text
1. Request arrives (HTTP/WS/NATS)
   │
2. Request creation (HttpRequest or WsxRequest)
   │  - Server generates internal ID (UUID)
   │  - request.server = reference to server (dual relationship)
   │
3. Registration in RequestRegistry
   │  - registry[request.id] = request
   │
4. Dispatch to handler (via Router)
   │
5. Handler processes, produces Response
   │
6. Send Response
   │  - For WS/NATS: response carries the same correlation ID from client (if present in data)
   │
7. De-registration from RequestRegistry
   │  - del registry[request.id]
```

## Request ID

- **`request.id`**: Internal ID generated by server (UUID), used by registry
- **Client ID** (optional): if client sends a correlation ID, it travels in request data, not as registry ID

## Request State

**Binary**:

- In registry → in progress
- Out of registry → completed

Additional info (timestamp, duration, etc.) obtained by querying the request itself.

## RequestRegistry - Functions

1. **Load snapshot**: know what the server is processing in real time
2. **Request ID as global identifier**: key for correlating logging, cache, metrics
3. **WS/NATS correlation**: associate response with pending request
4. **Lifecycle**: manage timeout, cancellation
