<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Genro API Explorer</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.18/cdn/themes/light.css">
  <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.18/cdn/shoelace-autoloader.js"></script>
  <script type="module" src="/_genro_api/static?file=tree.js"></script>
  <script type="module" src="/_genro_api/static?file=doc.js"></script>
  <script type="module" src="/_genro_api/static?file=tester.js"></script>
  <script type="module" src="/_genro_api/static?file=response.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      padding: 0.75rem 1rem;
      background: #1e293b;
      color: white;
      font-size: 1.1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    header select {
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      border: none;
    }
    main {
      flex: 1;
      min-height: 0;
    }
    sl-split-panel {
      --divider-width: 4px;
      height: 100%;
    }
    .panel {
      height: 100%;
      overflow: auto;
    }
    .panel-placeholder {
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      font-weight: bold;
      color: #64748b;
      background: #f8fafc;
      border: 1px dashed #cbd5e1;
    }
    .panel-tree { background: #f0fdf4; }
    .panel-doc { background: #eff6ff; border-color: #93c5fd; color: #1e40af; }
    .panel-tester { background: #fef3c7; border-color: #fcd34d; color: #92400e; }
    .panel-response { background: #fce7f3; border-color: #f9a8d4; color: #9d174d; }
  </style>
</head>
<body>
  <header>
    <span>Genro API Explorer</span>
    <select id="app-select">
      <option value="">-- Server Router --</option>
    </select>
  </header>
  <main>
    <sl-split-panel position="25">
      <div slot="start" class="panel panel-tree">
        <api-tree id="api-tree"></api-tree>
      </div>
      <div slot="end">
        <sl-split-panel vertical position="40">
          <div slot="start" class="panel panel-doc">
            <api-doc id="api-doc"></api-doc>
          </div>
          <div slot="end">
            <sl-split-panel position="50">
              <div slot="start" class="panel panel-tester">
                <api-tester id="api-tester"></api-tester>
              </div>
              <div slot="end" class="panel panel-response">
                <api-response id="api-response"></api-response>
              </div>
            </sl-split-panel>
          </div>
        </sl-split-panel>
      </div>
    </sl-split-panel>
  </main>

  <script type="module">
    const tree = document.getElementById("api-tree");
    const doc = document.getElementById("api-doc");
    const tester = document.getElementById("api-tester");
    const response = document.getElementById("api-response");
    const appSelect = document.getElementById("app-select");

    // Check if app is fixed via URL (e.g., /_genro_api/shop)
    const fixedApp = window.GENRO_API_INITIAL_APP || "";

    // Store current endpoint data for tester
    let currentEndpointData = null;

    async function init() {
      if (fixedApp) {
        // Fixed app mode: hide dropdown, use fixed app
        appSelect.style.display = "none";
        tree.loadNodes(fixedApp);
        doc.setApp(fixedApp);
        tester.setApp(fixedApp);
      } else {
        // Normal mode: populate dropdown and load server router
        await populateApps();
        tree.loadNodes();
      }
    }

    async function populateApps() {
      try {
        const res = await fetch("/_genro_api/apps");
        const data = await res.json();
        for (const app of data.apps || []) {
          const option = document.createElement("option");
          option.value = app.name;
          option.textContent = app.name;
          appSelect.appendChild(option);
        }
      } catch (err) {
        console.error("Failed to load apps:", err);
      }
    }

    // Reload tree when app selection changes
    appSelect.addEventListener("change", () => {
      const app = appSelect.value;
      tree.loadNodes(app);
      doc.setApp(app);
      doc.showPlaceholder();
      tester.setApp(app);
      tester.showPlaceholder();
      response.showPlaceholder();
    });

    // Handle node selection (endpoints and routers)
    tree.addEventListener("node-selected", async (e) => {
      console.log("Selected node:", e.detail);
      const currentApp = fixedApp || appSelect.value;
      doc.setApp(currentApp);
      tester.setApp(currentApp);

      // Load doc and get endpoint data for tester
      const params = new URLSearchParams({ path: e.detail.path });
      if (currentApp) params.set("app", currentApp);
      const url = `/_genro_api/getdoc?${params}`;

      try {
        const res = await fetch(url);
        const data = await res.json();
        doc.render(data);
        tester.setEndpoint(data);
        response.showPlaceholder();
      } catch (err) {
        console.error("Failed to load doc:", err);
      }
    });

    // Handle API response from tester
    tester.addEventListener("api-response", (e) => {
      console.log("API response:", e.detail);
      response.setResponse(e.detail);
    });

    init();
  </script>
</body>
</html>
